<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sci-fi Shooter</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        canvas {
            border: 10px solid rgb(1, 0, 52);
            background-clip: border-box;
        }  
    </style>
</head>
<body>
    <div class="menu">
        <h1 id="temporario"></h1>
        <div class="break"></div>
        <p>Setas para mover | Espaço para disparar</p>
        <div class="break"></div>
        <canvas id="canv" width="640" height="480" style="background-color: black;">Your browser does not support canvas.</canvas>
    </div>
    <footer>
        <a target="_blank" href="scoreboard.html">Scoreboard</a>
    </footer>
    <script src="score.js"></script>
    <script>
        localStorage.setItem("Scores", null)
        add_score(new Score("Ben 10", 500))
        add_score(new Score("Spongebob", 10000))

        const TAU = Math.PI * 2
        document.getElementById("temporario").innerText = "A cor escolhida foi " + localStorage.getItem("cor")
        
        const canvas = document.getElementById("canv")
        const width = canvas.width
        const height = canvas.height
        const ctx = canvas.getContext("2d")

        ctx.strokeStyle = "green";
        ctx.fillStyle = "white"


        // array que guarda todas as entidades para podermos loopar por cada e atualiza-la
        let enemies = []
        let bullets = []
        let enemy_bullets = []

        // classe base para demonstrar coisas
        class Object {
            constructor(x, y, width, height) {
                this.x = x
                this.y = y
                this.height = height
                this.width = width
            }
        }
        class Enemy extends Object {
            direction_x
            speed = 1
            random_bound = 0
            constructor(x, y, width, height) {
                super(x, y, width, height)
                let rand_num = Math.round(Math.random())
                
                if (rand_num == 0) {rand_num = -1;}
                
                this.direction_x = rand_num
                this.speed = getRandomInt(5) + 1
                this.random_bound = getRandomInt(200)
            }
        }

        class Bullet extends Object {
            speed = 10
            constructor(x, y, width, height) {
                super(x, y, width, height)
                
            }
        }

        class EnemyBullet extends Object {
            speed = 1
            constructor(x, y, width, height) {
                super(x, y, width, height)
            }
        }
        class Player extends Object {
            speed = 5
            can_shoot = true
            has_lost = false
            bullet_delay = 100 // em milisegundos
            constructor(x, y, width, height) {
                super(x, y, width, height)
            }
        }

        let player = new Player(width / 2 - 15, height - 100, 30, 30)
        let corPlayer = 'white'
        switch (localStorage.getItem("cor")) {
                case "Vermelho":
                    corPlayer = 'red'
                    break
                case "Rosa":
                    corPlayer = 'pink'
                    break
                case "Azul":
                    corPlayer = 'blue'
                    break
                case "Verde":
                    corPlayer = 'green'
                    break
                default:
                    corPlayer = 'white'
                    break
            }
        

        // criar alguns inimigos
        enemies.push(new Enemy(width / 2, 250, 20, 20))
        enemies.push(new Enemy(width / 2, 200, 20, 20))
        enemies.push(new Enemy(width / 2, 100, 20, 20))
        enemies.push(new Enemy(width / 2, 50, 20, 20))
        enemies.push(new Enemy(width / 2, 0, 20, 20))
        const n_enemies = enemies.length

        for (let i = 0; i < enemies.length; i++) {
            setInterval(() => {
                if (enemies[i] == undefined || enemies[i] == null) { return }
                enemy_bullets.push(new EnemyBullet(enemies[i].x + enemies[i].width /2, enemies[i].y + enemies[i].height / 2, 5, 15))
            }, Math.round((Math.random() + 0.1) * 8000))
        }
        // game loop
        function render() {
            if (enemies.length <= 0 || enemies.every((x) => x == undefined)) {
                setTimeout(() => {
                    ctx.font = "50px serif";
                    ctx.fillStyle = 'white'
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillText("YOU WON!", width / 2 - 110, height /2)

                    // scores, depois mudar
                    
                    
                    add_score(new Score(localStorage.getItem("Nome"), n_enemies))
                }, 1000)
                return
            } else if (player.has_lost) {
                setTimeout(() => {
                    ctx.font = "50px serif";
                    ctx.fillStyle = 'white'
                    ctx.clearRect(0, 0, width, height);
                    ctx.fillText("YOU LOST!", width / 2 - 115, height /2)
                }, 100)
                return
            }
            requestAnimationFrame(render);


            // apagar tudo antes de atualizar
            ctx.clearRect(0, 0, width, height);

            update(player)
            
            bullets.forEach(bullet => {
                update_bullet(bullet)
            })

            enemies.forEach(enemy => {
                update_enemy(enemy)
            });

            enemy_bullets.forEach(bul => {
                update_enemy_bul(bul)
            })
            
            
        }
        window.onload = render;

        // keys pressed é usado para podermos clicar em varios botoes ao mesmo tempo
        let keysPressed = {}

        document.addEventListener('keydown', (e) => {
            // movimento player
            keysPressed[e.key] = true
        })

        // tirar das keysPressed
        document.addEventListener('keyup', (e) => {
            delete keysPressed[e.key]
        })

        // helper functions
        function update(obj) {
            ctx.fillStyle = corPlayer

            if (keysPressed["ArrowLeft"] == true && player.x >= 0) {
                player.x -= player.speed;

            } if(keysPressed["ArrowUp"] == true && player.y > height - 150) {
                player.y -= player.speed;
                
            } if (keysPressed["ArrowRight"] == true && player.x + player.width <= width) {
                player.x += player.speed;

           } if (keysPressed["ArrowDown"] == true && player.y < height - player.height - 10) {
                player.y += player.speed;
            }
            
            // disparar
            if (keysPressed[" "] && player.can_shoot) {
                player.can_shoot = false
                setTimeout(() => {
                    player.can_shoot = true
                }, player.bullet_delay)
                let new_bul = new Bullet(player.x + player.width / 2 - 5, player.y + 10, 5, 10)
                bullets.push(new_bul)
            }

            ctx.fillRect(obj.x, obj.y, obj.width, obj.height)
        }

        // esta funcao é chamada para cada inimigo vivo e atualiza a sua posicao
        function update_enemy(enemy) {

            enemy.x += enemy.speed * enemy.direction_x
            //enemy.y = calcSineY(enemy.y)
            ctx.fillStyle = 'red'
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height)

            if (enemy.x + enemy.width >= width - enemy.random_bound) {
                enemy.direction_x *= -1
            } else if (enemy.x <= 0 + enemy.random_bound) {
                enemy.direction_x *= -1
            }
        }

        // esta funcao é chamada para cada bala disparada pelo inimigo vivo e atualiza a sua posicao
        function update_enemy_bul(bul) {
            bul.y += bul.speed
            ctx.fillStyle = 'purple'
            ctx.fillRect(bul.x, bul.y, bul.width, bul.height)
            if (collides(bul, player)) {
                player.has_lost = true
            }
            
        }

        // esta funcao atualiza cada bala disparada pelo player
        function update_bullet(bul) {
            bul.y -= bul.speed
            ctx.fillStyle = 'green'
            ctx.fillRect(bul.x, bul.y, bul.width, bul.height)

            // se a bala colide com um inimigo entao mata o inimigo 
            for (let i = 0; i < enemies.length; i++) {
                if (collides(enemies[i], bul)) {
                    delete enemies[i]
                    enemies.splice(i, i)
                }
            }

            if (bul.y + bul.height / 2 < 0) {
                delete bul
            }
        }

        
        function collides(obj1, obj2) {
            if (obj1 == null || obj2 == null) return
            return obj1.x < obj2.x + obj2.width &&
                obj1.x + obj1.width > obj2.x &&
                obj1.y < obj2.y + obj2.height &&
                obj1.y + obj1.height > obj2.y
        }
        
        function getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }
        
    </script>
</body>
</html>